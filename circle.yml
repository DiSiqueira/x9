machine:
  services:
    - docker

dependencies:
  override:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - DOCKER_REPO=$DOCKER_REPO DOCKER_IMAGE_VERSION=master make docker_build

deployment:
  master:
    branch: master
    commands:
      - DOCKER_REPO=$DOCKER_REPO DOCKER_IMAGE_VERSION=master make docker_build
  hub:
    tag: /^v[0-9]+\.[0-9]+\.[0-9]+-(alpha|beta|rc)(\.[0-9])*$/
    commands:
      - DOCKER_REPO=$DOCKER_REPO DOCKER_IMAGE_VERSION=$CIRCLE_TAG make docker_build
      - DOCKER_REPO=$DOCKER_REPO DOCKER_IMAGE_VERSION=$CIRCLE_TAG make docker_push
  stable:
    tag: /^v[0-9]+\.[0-9]+\.[0-9]+$/
    commands:
      - DOCKER_REPO=$DOCKER_REPO DOCKER_IMAGE_VERSION=$CIRCLE_TAG make docker_build
      - DOCKER_REPO=$DOCKER_REPO DOCKER_IMAGE_VERSION=$CIRCLE_TAG make docker_push
      - DOCKER_REPO=$DOCKER_REPO DOCKER_IMAGE_VERSION=latest make docker_push
